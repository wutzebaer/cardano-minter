<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.1.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

	<changeSet id="0000" author="peter">
		<preConditions onFail="MARK_RAN">
			<not>
				<tableExists tableName="account" />
			</not>
		</preConditions>
		<sqlFile path="schema.sql" />
	</changeSet>

	<changeSet id="0001" author="peter">

		<!-- create policy table -->
		<createTable tableName="policy">
			<column name="id" type="int8">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="policy_id" type="varchar(255)">
				<constraints nullable="false" unique="true" uniqueConstraintName="uk_ovg3csarwhdux4wx6xp9i3jns" />
			</column>
			<column name="policy" type="text">
				<constraints nullable="false" />
			</column>
			<column name="account_key" type="varchar(255)">
				<constraints nullable="false" referencedTableName="account" referencedColumnNames="key" foreignKeyName="fksbi5f4xmysdl6enia1kh52kua" />
			</column>
			<column name="address_id" type="int8">
				<constraints nullable="false" referencedTableName="address" referencedColumnNames="id" foreignKeyName="fkbfyiclqaqxntrg9epqj7ro3vf" />
			</column>
			<column name="policy_due_slot" type="int8">
				<constraints nullable="false" />
			</column>
		</createTable>

		<!-- copy policies -->
		<sql>
			insert into policy(id, policy_id, "policy", account_key, address_id, policy_due_slot)
			select nextval('hibernate_sequence'), policies.* from (
			select policy_id, policy, key, address_id, (policy::json->'scripts'->0->>'slot')::bigint from account a
			union
			select policy_id, policy, t.account_key,
			(select address_id from account a2 where a2."key"=t.account_key), (policy::json->'scripts'->0->>'slot')::bigint from "transaction" t
			) policies
		</sql>


		<addColumn tableName="mint_order_submission">
			<column name="policy_id" type="varchar(255)">
			</column>
		</addColumn>
		<update tableName="mint_order_submission">
			<column name="policy_id" valueComputed="(select policy_id from transaction t where t.mint_order_submission_id=mint_order_submission.id)"></column>
		</update>
		<addNotNullConstraint tableName="mint_order_submission" columnName="policy_id" />


		<dropColumn tableName="account">
			<column name="policy"></column>
			<column name="policy_due_date"></column>
			<column name="policy_id"></column>
		</dropColumn>

		<dropColumn tableName="transaction">
			<column name="policy"></column>
			<column name="policy_id"></column>
		</dropColumn>
	</changeSet>

	<changeSet id="0002" author="peter">
		<addColumn tableName="mint_order_submission">
			<column name="meta_data" type="text">
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="0003" author="peter">
		<addColumn tableName="transaction">
			<column name="submit_date" type="timestamp">
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="0004" author="peter">
		<createTable tableName="account_stake_positions">
			<column name="account_key" type="varchar(255)">
				<constraints nullable="false" referencedTableName="account" referencedColumnNames="key" foreignKeyName="fk393nrk2t6qhsbif4p3k0u9yhc" />
			</column>
			<column name="funds" type="int8">
				<constraints nullable="false" />
			</column>
			<column name="pool_hash" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="ticker_name" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="total_stake" type="int8">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet id="0005" author="peter">
		<addColumn tableName="registration_metadata">
			<column name="decimals" type="int4">
			</column>
		</addColumn>
	</changeSet>

	<changeSet id="0006" author="peter">
		<dropColumn columnName="meta_data" tableName="token_submission" />
		<addNotNullConstraint columnDataType="varchar(255)" columnName="asset_name" tableName="token_submission" validate="true" />
		<update tableName="registration_metadata">
			<column name="decimals" valueNumeric="0" />
			<where>decimals is null</where>
		</update>
		<addNotNullConstraint columnDataType="int" columnName="decimals" tableName="registration_metadata" validate="true" />
		<dropDefaultValue columnDataType="bigint" columnName="stake" tableName="account" />
		<addNotNullConstraint columnDataType="varchar(255)" columnName="target_address" tableName="mint_order_submission" validate="true" />
	</changeSet>

	<changeSet id="0007" author="peter">
		<createTable tableName="drop">
			<column autoIncrement="true" name="id" type="BIGINT">
				<constraints nullable="false" primaryKey="true" primaryKeyName="dropPK" />
			</column>
			<column name="max_per_transaction" type="INTEGER">
				<constraints nullable="false" />
			</column>
			<column name="name" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="price" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="profit_address" type="VARCHAR(255)">
				<constraints nullable="false" />
			</column>
			<column name="running" type="BOOLEAN">
				<constraints nullable="false" />
			</column>
			<column name="whitelist" type="TEXT">
				<constraints nullable="false" />
			</column>
			<column name="address_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="policy_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
		</createTable>
		<createTable tableName="drop_drop_nfts">
			<column name="drop_id" type="BIGINT">
				<constraints nullable="false" primaryKey="true" />
			</column>
			<column name="asset_name" type="VARCHAR(255)" />
			<column name="metadata" type="TEXT" />
			<column name="sequence" type="INTEGER">
				<constraints nullable="false" primaryKey="true" />
			</column>
		</createTable>
		<createTable tableName="drop_drop_nfts_available_asset_names">
			<column name="drop_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="drop_nfts_available_asset_names" type="VARCHAR(255)" />
		</createTable>
		<createTable tableName="drop_drop_nfts_sold_asset_names">
			<column name="drop_id" type="BIGINT">
				<constraints nullable="false" />
			</column>
			<column name="drop_nfts_sold_asset_names" type="VARCHAR(255)" />
		</createTable>
		<addForeignKeyConstraint baseColumnNames="address_id" baseTableName="drop" constraintName="FK80w65fl1r2meeg8vi1mfktyvn" deferrable="false" initiallyDeferred="false" referencedColumnNames="id" referencedTableName="address" validate="true" />
		<addForeignKeyConstraint baseColumnNames="policy_id" baseTableName="drop" constraintName="FKdtw63scvqledgdb4v2l3p84w5" deferrable="false" initiallyDeferred="false" referencedColumnNames="id" referencedTableName="policy" validate="true" />
		<addForeignKeyConstraint baseColumnNames="drop_id" baseTableName="drop_drop_nfts" constraintName="FKg2a3govenndtebyoqbjp22jgi" deferrable="false" initiallyDeferred="false" referencedColumnNames="id" referencedTableName="drop" validate="true" />
		<addForeignKeyConstraint baseColumnNames="drop_id" baseTableName="drop_drop_nfts_sold_asset_names" constraintName="FKlqbe33dd1ts7hll2kmdmqcujv" deferrable="false" initiallyDeferred="false" referencedColumnNames="id" referencedTableName="drop" validate="true" />
		<addForeignKeyConstraint baseColumnNames="drop_id" baseTableName="drop_drop_nfts_available_asset_names" constraintName="FKp0mldgolk9lktlyagnrv0o0a5" deferrable="false" initiallyDeferred="false" referencedColumnNames="id" referencedTableName="drop" validate="true" />
	</changeSet>


</databaseChangeLog>